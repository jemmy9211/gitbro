#!/bin/bash

# Function to check if a command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Get the absolute path of the script, resolving any symlinks
SCRIPT_PATH=$(realpath "$0")
# Get the project root (parent of bin/)
PROJECT_ROOT=$(dirname $(dirname "$SCRIPT_PATH"))
VENV_PATH="$PROJECT_ROOT/venv"

# Check if the virtual environment exists
if [ ! -d "$VENV_PATH" ]; then
    echo "Virtual environment not found at $VENV_PATH. Please run ./install.sh from the project root."
    exit 1
fi

# Activate the virtual environment
source "$VENV_PATH/bin/activate"

# Check if python3 is available in the environment
if ! command_exists python3; then
    echo "Python3 not found in the virtual environment. Please ensure the setup is correct."
    deactivate
    exit 1
fi

while true; do
    # Run the Python script to generate the commit message
    commit_message=$(python3 "$PROJECT_ROOT/src/generate_message.py")

    # Check if the commit message was successfully generated
    if [ $? -ne 0 ] || [ -z "$commit_message" ]; then
        echo "Failed to generate a commit message. Please ensure Ollama is running at http://localhost:11434 and changes are staged."
        deactivate
        exit 1
    fi

    echo -e "\nGenerated commit message:\n\"$commit_message\""
    echo -e "\nPlease choose an action:"
    echo "1) Accept and commit"
    echo "2) Regenerate"
    echo "3) Cancel and exit"
    read -p "Enter your choice (1-3): " choice

    case $choice in
        1)
            # Commit with the accepted message
            git commit -m "$commit_message"
            if [ $? -eq 0 ]; then
                echo "Commit successful! Commit message: \"$commit_message\""
            else
                echo "Failed to commit. Please check your Git setup."
            fi
            break
            ;;
        2)
            echo "Regenerating commit message..."
            continue
            ;;
        3)
            echo "Operation canceled."
            break
            ;;
        *)
            echo "Invalid option, please try again."
            continue
            ;;
    esac
done

# Deactivate the virtual environment
deactivate